# 503 错误解决方案

## 问题分析

你遇到的 **503 Service Unavailable** 错误表示 API 服务暂时不可用。根据你的配置，有以下几个可能的原因：

### 1. API Key 不完整 ⚠️

你的 `.env` 文件中的 API Key 看起来被截断了：

```env
# 当前配置（不完整）
SORA_API_KEY=sk-R8bKFp9b0RD1UXUotsYDwyyGNKpOpMV9NCRx917UXMnyFy5h
```

完整的 API Key 应该更长，参考示例：
```env
SORA_API_KEY=sk-HfmbZPrN2kWSJd0AJrS85xNBNeP0KKE45S0IjkrWAWavdBz8
```

### 2. API Base URL 不匹配

你使用的是：
```env
SORA_BASE_URL=https://api.nextaicore.com/
```

而示例中是：
```env
SORA_BASE_URL=https://apipro.maynor1024.live/
```

## 解决步骤

### 步骤 1: 检查并更新 API Key

1. 登录你的 API 提供商网站
2. 找到完整的 API Key（通常是 `sk-` 开头的长字符串）
3. 复制完整的 Key
4. 更新 `.env` 文件：

```env
SORA_API_KEY=你的完整API_Key
SORA_BASE_URL=https://api.nextaicore.com/
```

### 步骤 2: 验证账户状态

登录 API 提供商网站，检查：
- ✅ 账户余额是否充足
- ✅ API 配额是否用尽
- ✅ API Key 是否有效且未过期
- ✅ 服务是否正常运行（查看状态页面）

### 步骤 3: 测试 API 连接

重启服务器并测试：

```bash
# 停止当前服务器（如果正在运行）
# Ctrl+C

# 重新启动
npm start
```

### 步骤 4: 使用自动重试机制

我已经更新了代码，添加了对 503 错误的自动重试机制：

- ✅ 遇到 503 错误会自动重试 2 次
- ✅ 每次重试之间有渐进延迟（3秒、5秒、7秒）
- ✅ 显示友好的重试提示信息

## 常见 503 错误原因

### 1. API Key 问题（最常见）
- ❌ Key 不完整或复制错误
- ❌ Key 已过期
- ❌ Key 权限不足

### 2. 账户问题
- ❌ 余额不足
- ❌ 配额用尽
- ❌ 账户被暂停

### 3. 服务问题
- ❌ API 服务维护中
- ❌ 服务器过载
- ❌ 上游服务不可用

### 4. 网络问题
- ❌ 防火墙阻止
- ❌ DNS 解析失败
- ❌ 网络连接不稳定

## 测试 API 连接

你可以使用以下命令测试 API 是否可用：

```bash
# 测试 API 健康状态
curl -X GET "https://api.nextaicore.com/v1/models" \
  -H "Authorization: Bearer 你的API_Key"
```

如果返回 503，说明是 API 服务端的问题。

## 临时解决方案

如果 API 服务暂时不可用，你可以：

1. **等待 5-10 分钟后重试** - 服务可能正在维护
2. **切换到备用 API 端点**（如果有）
3. **联系 API 提供商技术支持**
4. **检查 API 状态页面**（通常在提供商网站上）

## 代码改进

我已经对代码做了以下改进：

### 1. 添加 503 错误自动重试
```javascript
// 如果是503（服务不可用）且还有重试次数，自动重试
if (response.status === 503 && retryCount < MAX_RETRIES) {
    console.log(`[Video] 503 Service Unavailable, retrying...`);
    updateProgressMessage(`⚠️ API 服务暂时不可用 (503)\n等待后重试...`);
    await new Promise(resolve => setTimeout(resolve, RETRY_DELAY));
    return await attemptVideoGeneration(requestBody, prompt, model, retryCount + 1);
}
```

### 2. 改进错误提示
现在会显示详细的 503 错误说明和解决建议。

### 3. 更好的错误日志
在浏览器控制台中可以看到更详细的错误信息。

## 下一步

1. **立即检查你的 `.env` 文件**，确保 API Key 完整
2. **验证账户状态**
3. **重启服务器**
4. **测试视频生成**

如果问题持续，请提供：
- 完整的错误日志（浏览器控制台）
- API 提供商的状态页面信息
- 账户状态截图（隐藏敏感信息）
