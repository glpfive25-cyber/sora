# 503 错误快速诊断和解决

## 🚨 当前问题

你遇到的错误：
```
Video stream error: Request failed with status code 503
```

这表示 **API 服务暂时不可用**。

## ✅ 立即执行的步骤

### 1️⃣ 运行诊断脚本（最重要！）

```bash
npm run test:api
```

这个脚本会：
- ✅ 检查 API Key 格式和长度
- ✅ 测试服务器连接
- ✅ 验证 API 认证
- ✅ 执行简单的 API 调用
- ✅ 给出具体的错误原因和建议

### 2️⃣ 检查 .env 文件

打开 `.env` 文件，确认：

```env
# 你当前的配置
SORA_API_KEY=sk-R8bKFp9b0RD1UXUotsYDwyyGNKpOpMV9NCRx917UXMnyFy5h
SORA_BASE_URL=https://api.nextaicore.com/
```

**问题检查清单：**
- [ ] API Key 是否完整？（通常 50+ 个字符）
- [ ] API Key 是否以 `sk-` 开头？
- [ ] 是否有多余的空格或换行？
- [ ] BASE_URL 是否正确？

### 3️⃣ 验证账户状态

登录 https://api.nextaicore.com/ 检查：

- [ ] 账户余额是否充足
- [ ] API 配额是否用尽
- [ ] API Key 是否有效且未过期
- [ ] 是否有服务状态公告

## 🔧 我已经做的修复

### 1. 添加了自动重试机制

现在遇到 503 错误会：
- 自动重试 2 次
- 每次间隔 3-7 秒（渐进延迟）
- 显示友好的重试提示

### 2. 改进了错误处理

- ✅ 正确识别 503 错误
- ✅ 区分不同类型的错误（503, 504, timeout）
- ✅ 提供详细的错误说明和解决建议
- ✅ 在流式响应中正确传递错误信息

### 3. 增强了日志记录

现在可以在浏览器控制台看到：
- 详细的错误信息
- 重试次数和状态
- API 响应内容

## 📊 503 错误的常见原因

### 原因 1: API Key 问题（最常见）
- ❌ Key 不完整或复制错误
- ❌ Key 已过期
- ❌ Key 权限不足

**解决方案：**
```bash
# 1. 运行诊断脚本
npm run test:api

# 2. 如果 Key 有问题，重新获取完整的 Key
# 3. 更新 .env 文件
# 4. 重启服务器
```

### 原因 2: 账户配额问题
- ❌ 余额不足
- ❌ 免费配额用尽
- ❌ 请求频率超限

**解决方案：**
- 登录账户充值
- 升级套餐
- 等待配额重置

### 原因 3: 服务端问题
- ❌ API 服务维护中
- ❌ 服务器过载
- ❌ 上游服务故障

**解决方案：**
- 查看服务状态页面
- 等待 5-10 分钟后重试
- 联系技术支持

### 原因 4: 网络问题
- ❌ 防火墙阻止
- ❌ DNS 解析失败
- ❌ 代理配置错误

**解决方案：**
```bash
# 测试网络连接
curl -I https://api.nextaicore.com/

# 如果无法访问，检查网络设置
```

## 🧪 测试步骤

### 步骤 1: 运行诊断脚本

```bash
npm run test:api
```

查看输出，找到失败的测试。

### 步骤 2: 根据诊断结果修复

如果诊断显示：

**"API Key 无效或已过期"**
→ 重新获取 API Key

**"服务暂时不可用 (503)"**
→ 检查账户状态和服务状态

**"无法连接到服务器"**
→ 检查网络和 BASE_URL

### 步骤 3: 重启服务器

```bash
# 停止当前服务器（Ctrl+C）
# 重新启动
npm start
```

### 步骤 4: 测试视频生成

在浏览器中：
1. 打开 http://localhost:3000
2. 输入简单的提示词（如："一只猫在玩球"）
3. 选择 `sora_video2` 模型（最稳定）
4. 点击生成

## 📝 如果问题持续

如果按照上述步骤操作后仍然出现 503 错误：

### 收集信息

1. **运行诊断脚本并保存输出：**
```bash
npm run test:api > diagnostic-output.txt
```

2. **查看浏览器控制台错误：**
- 打开浏览器开发者工具（F12）
- 切换到 Console 标签
- 复制所有错误信息

3. **查看服务器日志：**
- 查看运行 `npm start` 的终端输出
- 找到包含 `[Server]` 或 `[Sora2]` 的错误信息

### 联系支持

准备以下信息：
- 诊断脚本输出
- 浏览器控制台错误
- 服务器日志
- 账户状态截图（隐藏敏感信息）

## 💡 临时解决方案

如果需要立即使用，可以尝试：

### 方案 1: 使用备用 API 端点（如果有）

```env
# 在 .env 中尝试不同的 BASE_URL
SORA_BASE_URL=https://apipro.maynor1024.live/
```

### 方案 2: 减少请求复杂度

- 使用更短的提示词
- 选择 `sora_video2` 而不是 15 秒版本
- 避免使用图生视频功能

### 方案 3: 增加重试次数

如果偶尔成功，可以增加重试次数。编辑 `public/app.js`：

```javascript
// 找到这一行（约在第 650 行）
const MAX_RETRIES = 2;

// 改为
const MAX_RETRIES = 5; // 增加到 5 次重试
```

## 🎯 预防措施

为了避免将来出现类似问题：

1. **定期检查账户余额**
2. **监控 API 配额使用情况**
3. **保存完整的 API Key 备份**
4. **关注服务状态更新**
5. **使用稳定的模型（sora_video2）**

## 📞 获取帮助

如果需要进一步帮助：

1. **API 提供商技术支持**
   - 网站：https://api.nextaicore.com/
   - 查找"支持"或"帮助"页面

2. **查看文档**
   - API 文档
   - 常见问题解答
   - 状态页面

3. **社区支持**
   - 开发者论坛
   - Discord/Telegram 群组
   - GitHub Issues

---

**记住：503 错误通常是临时性的，大多数情况下通过检查 API Key 和账户状态就能解决！**
