# è§’è‰²è§†é¢‘è¿›åº¦é—®é¢˜æŽ’æŸ¥

## ðŸ” é—®é¢˜æè¿°

è§’è‰²è§†é¢‘ç”Ÿæˆæ—¶æ˜¾ç¤º"æ­£åœ¨åˆå§‹åŒ–..."ä½†æ²¡æœ‰è¿›åº¦æ›´æ–°ã€‚

## ðŸŽ¯ å¯èƒ½çš„åŽŸå› 

### 1. ä»»åŠ¡ ID æœªæ­£ç¡®æå–

Chat API è¿”å›žçš„å“åº”æ ¼å¼å¯èƒ½ä¸åŒ…å« `task_xxx` æ ¼å¼çš„ IDã€‚

### 2. è½®è¯¢æœªå¯åŠ¨

å¦‚æžœä»»åŠ¡ ID æå–å¤±è´¥ï¼Œè½®è¯¢ä¸ä¼šå¯åŠ¨ï¼Œè¿›åº¦å°±ä¸ä¼šæ›´æ–°ã€‚

### 3. API å“åº”æ ¼å¼ä¸åŒ

ä¸åŒçš„ API æä¾›å•†å¯èƒ½è¿”å›žä¸åŒçš„å“åº”æ ¼å¼ã€‚

## âœ… è¯Šæ–­æ­¥éª¤

### æ­¥éª¤ 1: æŸ¥çœ‹æµè§ˆå™¨æŽ§åˆ¶å°

æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰ï¼ŒæŸ¥æ‰¾ï¼š

```javascript
[CHARACTER] Response: { ... }
[CHARACTER] Response status: 200 OK: true
[CHARACTER] Data ID: xxx Type: string
```

**å…³é”®ä¿¡æ¯**ï¼š
- `data.id` çš„å€¼æ˜¯ä»€ä¹ˆï¼Ÿ
- æ˜¯ `task_xxx` æ ¼å¼è¿˜æ˜¯ `foaicmpl-xxx` æ ¼å¼ï¼Ÿ
- æ˜¯å¦æœ‰ `data.content` å­—æ®µï¼Ÿ

### æ­¥éª¤ 2: æ£€æŸ¥å“åº”å†…å®¹

å¦‚æžœ `data.id` ä¸æ˜¯ `task_xxx` æ ¼å¼ï¼ŒæŸ¥çœ‹ `data.content`ï¼š

```javascript
[CHARACTER] Chat completion response: {
  id: "foaicmpl-xxx",
  content: "...è¿™é‡Œå¯èƒ½åŒ…å«ä»»åŠ¡ ID..."
}
```

### æ­¥éª¤ 3: æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—

åœ¨è¿è¡Œ `npm start` çš„ç»ˆç«¯ä¸­æŸ¥æ‰¾ï¼š

```
[Server] Creating video with character: { ... }
[Sora2] Video with character creation response: { ... }
[Sora2] Response content: ...
[Sora2] Extracted task ID: task_xxx
```

## ðŸ› ï¸ ä¸´æ—¶è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: æ·»åŠ æ¨¡æ‹Ÿè¿›åº¦

å¦‚æžœæ— æ³•èŽ·å–çœŸå®žè¿›åº¦ï¼Œå¯ä»¥æ·»åŠ æ¨¡æ‹Ÿè¿›åº¦æ¡ï¼š

```javascript
// åœ¨ pollCharacterVideoTask å‡½æ•°å¼€å§‹æ—¶æ·»åŠ 
let simulatedProgress = 10;
const progressInterval = setInterval(() => {
    if (simulatedProgress < 90) {
        simulatedProgress += 2;
        updateCharacterStatus('è§†é¢‘ç”Ÿæˆä¸­...', simulatedProgress);
    }
}, 3000);

// åœ¨ä»»åŠ¡å®Œæˆæˆ–å¤±è´¥æ—¶æ¸…é™¤
clearInterval(progressInterval);
```

### æ–¹æ¡ˆ 2: ä½¿ç”¨å›ºå®šæ¶ˆæ¯

å¦‚æžœè½®è¯¢æ­£å¸¸å·¥ä½œä½†è¿›åº¦ä¸æ›´æ–°ï¼Œå¯èƒ½æ˜¯çŠ¶æ€æ¶ˆæ¯çš„é—®é¢˜ï¼š

```javascript
// ä¿®æ”¹ updateCharacterStatus è°ƒç”¨
updateCharacterStatus('ðŸŽ¬ è§†é¢‘ç”Ÿæˆä¸­ï¼Œé¢„è®¡éœ€è¦ 1-3 åˆ†é’Ÿ...', 50);
```

### æ–¹æ¡ˆ 3: æ£€æŸ¥ HTML å…ƒç´ 

ç¡®ä¿ HTML ä¸­æœ‰è¿™äº›å…ƒç´ ï¼š

```html
<div id="characterProgressIndicator" class="hidden">
  <div id="characterProgressBar"></div>
  <p id="characterStatusText"></p>
  <p id="characterElapsedTime"></p>
</div>
```

## ðŸ“ å®Œæ•´çš„è°ƒè¯•æµç¨‹

### 1. åˆ·æ–°é¡µé¢

```bash
# ç¡®ä¿æœåŠ¡å™¨åœ¨è¿è¡Œ
npm start
```

### 2. æ‰“å¼€æŽ§åˆ¶å°

æŒ‰ F12 æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·

### 3. ç”Ÿæˆè§’è‰²è§†é¢‘

è¾“å…¥æç¤ºè¯å¹¶ç‚¹å‡»"ç”Ÿæˆè§†é¢‘"

### 4. æŸ¥çœ‹æ—¥å¿—

åœ¨æŽ§åˆ¶å°ä¸­æŸ¥æ‰¾ä»¥ä¸‹æ—¥å¿—ï¼š

```javascript
// è¯·æ±‚å‘é€
[CHARACTER] Request data: { ... }
[CHARACTER] Using local server proxy to avoid CORS issues

// å“åº”æŽ¥æ”¶
[CHARACTER] Response: { ... }
[CHARACTER] Response status: 200 OK: true
[CHARACTER] Data ID: xxx Type: string

// ä»»åŠ¡ ID æ£€æŸ¥
// å¦‚æžœæ˜¯ task_xxx æ ¼å¼
[CHARACTER] Task ID detected, starting poll

// å¦‚æžœä¸æ˜¯
[CHARACTER] Chat completion response: { ... }
```

### 5. æŸ¥çœ‹è½®è¯¢æ—¥å¿—

å¦‚æžœè½®è¯¢å¯åŠ¨ï¼Œåº”è¯¥çœ‹åˆ°ï¼š

```javascript
[CHARACTER] Polling task task_xxx, attempt 1/120
[CHARACTER] Task status: { status: "pending", ... }
[CHARACTER] Polling task task_xxx, attempt 2/120
[CHARACTER] Task status: { status: "running", ... }
...
[CHARACTER] Task completed! { status: "completed", video_url: "..." }
```

## ðŸ”§ ä»£ç ä¿®å¤å»ºè®®

### ä¿®å¤ 1: æ”¹è¿›ä»»åŠ¡ ID æå–

```javascript
if (response.ok && data.id) {
    const isTaskId = data.id.startsWith('task_');
    
    console.log('[CHARACTER] ID format check:', {
        id: data.id,
        isTaskId: isTaskId,
        hasContent: !!data.content
    });
    
    if (isTaskId) {
        // æ­£å¸¸è½®è¯¢
        pollCharacterVideoTask(data.id);
    } else if (data.content) {
        // å°è¯•ä»Ž content æå–
        const taskIdMatch = data.content.match(/task_[a-z0-9]+/i);
        if (taskIdMatch) {
            console.log('[CHARACTER] Extracted task ID from content:', taskIdMatch[0]);
            pollCharacterVideoTask(taskIdMatch[0]);
        } else {
            // æ— æ³•æå–ï¼Œæ˜¾ç¤ºå†…å®¹
            console.warn('[CHARACTER] Could not extract task ID');
            updateCharacterStatus('ç”Ÿæˆä¸­ï¼Œæ— æ³•èŽ·å–è¿›åº¦...', 50);
        }
    }
}
```

### ä¿®å¤ 2: æ·»åŠ è¶…æ—¶å¤„ç†

```javascript
// åœ¨ showCharacterProgress åŽæ·»åŠ 
setTimeout(() => {
    const progressIndicator = document.getElementById('characterProgressIndicator');
    if (progressIndicator && !progressIndicator.classList.contains('hidden')) {
        // å¦‚æžœ 30 ç§’åŽè¿˜åœ¨æ˜¾ç¤ºè¿›åº¦ï¼Œè¯´æ˜Žå¯èƒ½å¡ä½äº†
        console.warn('[CHARACTER] Progress indicator still showing after 30s');
        updateCharacterStatus('âš ï¸ ç”Ÿæˆä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…...', 30);
    }
}, 30000);
```

### ä¿®å¤ 3: æ·»åŠ å¿ƒè·³æ›´æ–°

```javascript
// åœ¨è½®è¯¢æœŸé—´å®šæœŸæ›´æ–°è¿›åº¦
let heartbeatProgress = 10;
const heartbeat = setInterval(() => {
    if (heartbeatProgress < 85) {
        heartbeatProgress += 5;
        updateCharacterStatus('ðŸŽ¬ è§†é¢‘ç”Ÿæˆä¸­...', heartbeatProgress);
    }
}, 10000); // æ¯ 10 ç§’æ›´æ–°ä¸€æ¬¡

// åœ¨ä»»åŠ¡å®Œæˆæ—¶æ¸…é™¤
clearInterval(heartbeat);
```

## ðŸ’¡ å¿«é€Ÿæµ‹è¯•

### æµ‹è¯• 1: æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨

åœ¨æµè§ˆå™¨æŽ§åˆ¶å°æ‰§è¡Œï¼š

```javascript
console.log('Progress Indicator:', document.getElementById('characterProgressIndicator'));
console.log('Status Text:', document.getElementById('characterStatusText'));
console.log('Progress Bar:', document.getElementById('characterProgressBar'));
```

å¦‚æžœè¿”å›ž `null`ï¼Œè¯´æ˜Ž HTML å…ƒç´ ä¸å­˜åœ¨ã€‚

### æµ‹è¯• 2: æ‰‹åŠ¨æ›´æ–°è¿›åº¦

åœ¨æµè§ˆå™¨æŽ§åˆ¶å°æ‰§è¡Œï¼š

```javascript
const statusText = document.getElementById('characterStatusText');
const progressBar = document.getElementById('characterProgressBar');

if (statusText) statusText.textContent = 'æµ‹è¯•è¿›åº¦æ›´æ–°';
if (progressBar) progressBar.style.width = '50%';
```

å¦‚æžœè¿›åº¦æ¡æ›´æ–°äº†ï¼Œè¯´æ˜Žå‡½æ•°æ˜¯æ­£å¸¸çš„ï¼Œé—®é¢˜åœ¨äºŽæ•°æ®æµã€‚

### æµ‹è¯• 3: æ£€æŸ¥è½®è¯¢æ˜¯å¦å¯åŠ¨

åœ¨æµè§ˆå™¨æŽ§åˆ¶å°æ‰§è¡Œï¼š

```javascript
// ç”Ÿæˆè§†é¢‘åŽï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰è½®è¯¢æ—¥å¿—
// åº”è¯¥æ¯ 5 ç§’çœ‹åˆ°ä¸€æ¬¡ [CHARACTER] Polling task...
```

## ðŸ“Š å¸¸è§æƒ…å†µ

### æƒ…å†µ 1: è¿›åº¦å¡åœ¨"æ­£åœ¨åˆå§‹åŒ–..."

**åŽŸå› **: è½®è¯¢æœªå¯åŠ¨

**è§£å†³**: 
- æ£€æŸ¥ä»»åŠ¡ ID æ˜¯å¦æ­£ç¡®æå–
- æŸ¥çœ‹æŽ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯

### æƒ…å†µ 2: è¿›åº¦æ›´æ–°ä½†å¾ˆæ…¢

**åŽŸå› **: è½®è¯¢é—´éš”å¤ªé•¿ï¼ˆ5 ç§’ï¼‰

**è§£å†³**: 
- è¿™æ˜¯æ­£å¸¸çš„ï¼Œç­‰å¾…å³å¯
- æˆ–è€…æ·»åŠ æ¨¡æ‹Ÿè¿›åº¦æ¡

### æƒ…å†µ 3: è¿›åº¦ä¸€ç›´åœ¨æ›´æ–°ä½†ä¸å®Œæˆ

**åŽŸå› **: ä»»åŠ¡å¯èƒ½å¤±è´¥æˆ–å¡ä½

**è§£å†³**: 
- æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—
- æ£€æŸ¥ API çŠ¶æ€
- æ‰‹åŠ¨æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€

## ðŸŽ¯ ä¸‹ä¸€æ­¥

1. **åˆ·æ–°é¡µé¢**
2. **æ‰“å¼€æŽ§åˆ¶å°**ï¼ˆF12ï¼‰
3. **ç”Ÿæˆè§’è‰²è§†é¢‘**
4. **å¤åˆ¶æŽ§åˆ¶å°çš„æ‰€æœ‰æ—¥å¿—**
5. **æŸ¥çœ‹æ˜¯å¦æœ‰ä»»åŠ¡ ID è¢«æå–**

å¦‚æžœçœ‹åˆ°ä»»åŠ¡ ID è¢«æå–ï¼Œä½†è¿›åº¦ä¸æ›´æ–°ï¼Œå¯èƒ½æ˜¯è½®è¯¢çš„é—®é¢˜ã€‚
å¦‚æžœæ²¡æœ‰çœ‹åˆ°ä»»åŠ¡ IDï¼Œå¯èƒ½æ˜¯å“åº”æ ¼å¼çš„é—®é¢˜ã€‚

---

**æä¾›æŽ§åˆ¶å°æ—¥å¿—å¯ä»¥å¸®åŠ©æˆ‘æ›´å‡†ç¡®åœ°è¯Šæ–­é—®é¢˜ï¼**
