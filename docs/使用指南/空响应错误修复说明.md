# 空响应错误修复说明

## 问题描述
用户在生成视频时遇到 "API返回空响应，请重试" 错误。

## 根本原因
当使用流式模式（stream mode）调用视频生成API时，某些情况下API不返回流式内容，而是使用V2 API格式（返回task_id）。原代码在收到空流时会返回空响应，导致前端报错。

## 修复内容

### 1. sora2.js - 改进空流处理
**位置**: `generateVideoStream` 方法的 `response.data.on('end')` 事件处理

**修改前**: 返回空响应 `content: ''`
```javascript
resolve({
  choices: [{
    message: {
      role: 'assistant',
      content: ''
    }
  }]
});
```

**修改后**: 抛出错误，提示需要使用V2 API
```javascript
reject(new Error('API返回空流，可能需要使用V2 API轮询模式'));
```

### 2. server.js - 自动降级到V2 API
**位置**: `/api/video/generate` 端点的流式错误处理

**新增功能**: 当流式模式失败时，自动切换到V2 API（task-based）模式
```javascript
if (streamError.message.includes('V2 API') || streamError.message.includes('空流')) {
  console.log('[Server] Stream returned empty, falling back to V2 API (task-based)');
  const v2Response = await soraInstance.generateVideo(prompt, videoOptions);
  // 返回task_id供前端轮询
}
```

### 3. public/app.js - 更新错误提示
**位置**: `attemptVideoGeneration` 方法的空响应检查

**修改**: 更新错误消息，说明已自动切换到任务模式

## 工作流程

1. **首次尝试**: 使用流式模式调用API
2. **检测空流**: 如果API返回空流（可能是V2 API格式）
3. **自动降级**: 服务器自动切换到V2 API，获取task_id
4. **任务轮询**: 前端收到task_id后，自动开始轮询任务状态
5. **获取结果**: 任务完成后返回视频URL

## 优势

- **自动恢复**: 无需用户手动重试或切换模式
- **兼容性**: 同时支持流式和任务式两种API格式
- **用户体验**: 减少错误提示，提高成功率

## 测试建议

1. 测试正常的流式视频生成
2. 测试需要V2 API的场景（如角色视频）
3. 验证自动降级机制是否正常工作
4. 检查任务轮询是否正确显示进度
