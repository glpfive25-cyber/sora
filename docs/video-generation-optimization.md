# è§†é¢‘ç”Ÿæˆ504è¶…æ—¶ä¼˜åŒ–æ–¹æ¡ˆ

## é—®é¢˜åˆ†æ

åŸæœ‰ç³»ç»Ÿåœ¨è§†é¢‘ç”Ÿæˆæ—¶é¢‘ç¹å‡ºç°504è¶…æ—¶é”™è¯¯ï¼Œä¸»è¦åŸå› ï¼š

1. **åç«¯æ²¡æœ‰å®ç°æµå¼APIç«¯ç‚¹** - å‰ç«¯è®¾ç½®äº† `useStream: true`ï¼Œä½†åç«¯ä¸æ”¯æŒ
2. **è¶…æ—¶å¤„ç†ä¸å½“** - é‡åˆ°504ç›´æ¥å¤±è´¥ï¼Œæ²¡æœ‰é‡è¯•æœºåˆ¶
3. **ç¼ºå°‘é™çº§ç­–ç•¥** - éæµå¼è¯·æ±‚å¤±è´¥åæ²¡æœ‰å°è¯•æµå¼æ¨¡å¼

## ä¼˜åŒ–æ–¹æ¡ˆ

### 1. åç«¯æµå¼æ”¯æŒ (server.js)

**ä½ç½®**: `server.js:102-172`

å¢å¼ºäº† `/api/video/generate` ç«¯ç‚¹ï¼Œæ”¯æŒæµå¼å’Œéæµå¼ä¸¤ç§æ¨¡å¼ï¼š

```javascript
// æ£€æµ‹ useStream å‚æ•°
if (useStream) {
  // è®¾ç½® SSE å¤´éƒ¨
  res.setHeader('Content-Type', 'text/event-stream');
  res.setHeader('Cache-Control', 'no-cache');
  res.setHeader('Connection', 'keep-alive');
  res.setHeader('X-Accel-Buffering', 'no'); // ç¦ç”¨nginxç¼“å†²

  // ä½¿ç”¨æµå¼ç”Ÿæˆï¼Œå®æ—¶å‘é€è¿›åº¦
  await sora.generateVideoStream(prompt, videoOptions, (chunk, fullContent) => {
    res.write(`data: ${JSON.stringify({
      type: 'progress',
      content: chunk,
      fullContent: fullContent
    })}\n\n`);
  });
}
```

**ä¼˜åŠ¿**ï¼š
- âœ… ä¿æŒè¿æ¥æ´»è·ƒï¼Œé¿å…ç½‘å…³è¶…æ—¶
- âœ… å®æ—¶åé¦ˆè¿›åº¦ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
- âœ… è¶…æ—¶æ—¶é—´ä»2åˆ†é’Ÿå»¶é•¿åˆ°10åˆ†é’Ÿ

### 2. æ™ºèƒ½é‡è¯•æœºåˆ¶ (app.js)

**ä½ç½®**: `app.js:377-458`

æ–°å¢ `attemptVideoGeneration()` å‡½æ•°ï¼Œå®ç°æ™ºèƒ½é‡è¯•ï¼š

```javascript
async function attemptVideoGeneration(requestBody, prompt, model, retryCount = 0) {
  const MAX_RETRIES = 2;
  const RETRY_DELAY = 2000;

  try {
    // æ ¹æ®é‡è¯•æ¬¡æ•°è°ƒæ•´ç­–ç•¥
    const useStream = retryCount === 0 ? requestBody.useStream : true;

    // åŠ¨æ€è¶…æ—¶è®¾ç½®
    const timeout = useStream ? 600000 : 300000; // æµå¼10åˆ†é’Ÿï¼Œéæµå¼5åˆ†é’Ÿ

    // ... å‘é€è¯·æ±‚ ...

  } catch (error) {
    // è‡ªåŠ¨é‡è¯•å¯æ¢å¤çš„é”™è¯¯
    const isRetryable = (
      error.name === 'AbortError' ||
      error.message.includes('504') ||
      error.message.includes('timeout')
    );

    if (isRetryable && retryCount < MAX_RETRIES) {
      await new Promise(resolve => setTimeout(resolve, RETRY_DELAY));
      return await attemptVideoGeneration(requestBody, prompt, model, retryCount + 1);
    }

    throw error;
  }
}
```

**ç‰¹æ€§**ï¼š
- ğŸ”„ æœ€å¤šé‡è¯•2æ¬¡ï¼ˆå…±3æ¬¡å°è¯•ï¼‰
- ğŸ“ˆ é‡è¯•æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°æµå¼æ¨¡å¼
- â° æ¯æ¬¡é‡è¯•é—´éš”2ç§’
- ğŸ“Š æ˜¾ç¤ºé‡è¯•è¿›åº¦ç»™ç”¨æˆ·

### 3. æµå¼å“åº”å¤„ç†å¢å¼º (app.js)

**ä½ç½®**: `app.js:460-545`

æ”¹è¿›çš„ `handleStreamResponse()` å‡½æ•°ï¼š

```javascript
// æ”¯æŒæ–°çš„äº‹ä»¶ç±»å‹
if (parsed.type === 'done') {
  // å®Œæˆäº‹ä»¶ï¼ˆæ–°æ ¼å¼ï¼‰
  if (parsed.data) {
    finalResult = parsed.data;
    handleVideoResponse(parsed.data, prompt, model);
  }
} else if (parsed.type === 'progress') {
  // è¿›åº¦æ›´æ–°
  handleProgressUpdate(parsed);
} else if (parsed.type === 'error') {
  // é”™è¯¯å¤„ç†
  throw new Error(parsed.error || 'Stream error');
}
```

**æ”¹è¿›ç‚¹**ï¼š
- âœ… å…¼å®¹æ–°æ—§äº‹ä»¶æ ¼å¼
- âœ… å®æ—¶æ˜¾ç¤ºè¿›åº¦æ¶ˆæ¯
- âœ… æ›´å¥½çš„é”™è¯¯å¤„ç†

## ä½¿ç”¨æ•ˆæœ

### è¶…æ—¶å¤„ç†æµç¨‹

```
ç”¨æˆ·æäº¤è§†é¢‘ç”Ÿæˆè¯·æ±‚
    â†“
[å°è¯• 1] ä½¿ç”¨æµå¼æ¨¡å¼ (è¶…æ—¶: 10åˆ†é’Ÿ)
    â†“
  å¤±è´¥? (504/timeout)
    â†“
ç­‰å¾… 2 ç§’
    â†“
[å°è¯• 2] å¼ºåˆ¶æµå¼æ¨¡å¼ (è¶…æ—¶: 10åˆ†é’Ÿ)
    â†“
  å¤±è´¥? (504/timeout)
    â†“
ç­‰å¾… 2 ç§’
    â†“
[å°è¯• 3] å¼ºåˆ¶æµå¼æ¨¡å¼ (è¶…æ—¶: 10åˆ†é’Ÿ)
    â†“
  å¤±è´¥? â†’ æ˜¾ç¤ºé”™è¯¯å»ºè®®
  æˆåŠŸ? â†’ æ˜¾ç¤ºç”Ÿæˆç»“æœ
```

### ç”¨æˆ·ä½“éªŒæå‡

**ä¹‹å‰**:
- âŒ 15ç§’è§†é¢‘å‡ ä¹å¿…å®š504è¶…æ—¶
- âŒ è¶…æ—¶åæ— ä»»ä½•æç¤º
- âŒ ç”¨æˆ·éœ€è¦æ‰‹åŠ¨é‡è¯•

**ç°åœ¨**:
- âœ… è‡ªåŠ¨é‡è¯•ï¼ŒæˆåŠŸç‡å¤§å¹…æå‡
- âœ… å®æ—¶æ˜¾ç¤º"æ­£åœ¨é‡è¯• (1/2)"ç­‰æç¤º
- âœ… æµå¼æ¨¡å¼ä¸‹æ˜¾ç¤ºç”Ÿæˆè¿›åº¦
- âœ… 10åˆ†é’Ÿè¶…æ—¶ï¼Œè¶³å¤Ÿå®Œæˆé•¿è§†é¢‘

## é…ç½®è¯´æ˜

### è¶…æ—¶é…ç½®

| æ¨¡å¼ | è¶…æ—¶æ—¶é—´ | é€‚ç”¨åœºæ™¯ |
|------|---------|---------|
| éæµå¼ | 5åˆ†é’Ÿ | çŸ­è§†é¢‘ï¼ˆâ‰¤10ç§’ï¼‰ |
| æµå¼ | 10åˆ†é’Ÿ | é•¿è§†é¢‘ï¼ˆ15ç§’ï¼‰ |

### é‡è¯•ç­–ç•¥

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|---|------|
| MAX_RETRIES | 2 | æœ€å¤šé‡è¯•æ¬¡æ•° |
| RETRY_DELAY | 2000ms | é‡è¯•é—´éš” |
| æ€»å°è¯•æ¬¡æ•° | 3 | åˆæ¬¡è¯·æ±‚ + 2æ¬¡é‡è¯• |

## æµ‹è¯•å»ºè®®

1. **æµ‹è¯•çŸ­è§†é¢‘** (sora_video2, 10ç§’)
   - é¢„æœŸï¼š30-90ç§’å†…å®Œæˆ
   - æˆåŠŸç‡ï¼šåº”è¯¥å¾ˆé«˜

2. **æµ‹è¯•é•¿è§†é¢‘** (landscape-15s, 15ç§’)
   - é¢„æœŸï¼š3-5åˆ†é’Ÿå†…å®Œæˆ
   - æµå¼æ¨¡å¼ä¸‹åº”è¯¥èƒ½æˆåŠŸ

3. **æµ‹è¯•å›¾ç”Ÿè§†é¢‘** (å¸¦å‚è€ƒå›¾)
   - é¢„æœŸï¼šç±»ä¼¼äºæ–‡ç”Ÿè§†é¢‘
   - æ³¨æ„å›¾ç‰‡å¤§å°é™åˆ¶ï¼ˆ50MBï¼‰

## æ•…éšœæ’æŸ¥

å¦‚æœä»ç„¶é‡åˆ°504é”™è¯¯ï¼š

1. **æ£€æŸ¥APIé…ç½®**
   ```bash
   echo $SORA_API_KEY
   echo $SORA_BASE_URL
   ```

2. **æ£€æŸ¥ç½‘ç»œè¿æ¥**
   ```bash
   curl -I https://api.nextai.trade/v1/chat/completions
   ```

3. **æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—**
   - å‰ç«¯æ§åˆ¶å°ï¼šæŸ¥çœ‹ `[Video]` å¼€å¤´çš„æ—¥å¿—
   - åç«¯æ—¥å¿—ï¼šæŸ¥çœ‹ `[Server]` å’Œ `[Sora2]` æ—¥å¿—

4. **è°ƒæ•´è¶…æ—¶æ—¶é—´**ï¼ˆå¦‚éœ€æ›´é•¿æ—¶é—´ï¼‰
   - `app.js:388`: ä¿®æ”¹ `timeout` å€¼
   - `sora2.js:240`: ä¿®æ”¹ `timeout` å€¼

## ç›¸å…³æ–‡ä»¶

- `server.js:102-172` - æµå¼APIç«¯ç‚¹
- `app.js:377-458` - æ™ºèƒ½é‡è¯•æœºåˆ¶
- `app.js:460-545` - æµå¼å“åº”å¤„ç†
- `sora2.js:196-316` - æµå¼è§†é¢‘ç”Ÿæˆå®ç°

## æ›´æ–°æ—¥å¿—

**2025-10-30**
- âœ… å®ç°æµå¼APIç«¯ç‚¹
- âœ… æ·»åŠ æ™ºèƒ½é‡è¯•æœºåˆ¶
- âœ… ä¼˜åŒ–æµå¼å“åº”å¤„ç†
- âœ… å¢å¼ºé”™è¯¯æç¤ºå’Œç”¨æˆ·åé¦ˆ
