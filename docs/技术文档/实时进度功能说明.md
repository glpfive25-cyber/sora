# 实时进度显示功能说明

## 概述

系统现已支持**实时进度更新**，用户在生成视频时可以看到：
- 实时进度百分比
- 当前处理状态
- 已等待时间
- 预计剩余时间

## 技术实现

### 1. 前端实现 (app.js)

#### 核心函数

##### `handleStreamResponse(response, prompt, model)`
处理服务器的流式 SSE 响应。

**功能：**
- 读取流式数据
- 解析 SSE 事件
- 分发到对应的处理函数

**参数：**
- `response` - fetch 响应对象
- `prompt` - 用户输入的提示词
- `model` - 使用的模型名称

##### `handleProgressUpdate(progressData)`
处理进度更新事件。

**支持的格式：**
```javascript
// 格式1：包含百分比的文本
{ type: 'progress', content: '正在生成视频... 45%' }

// 格式2：纯百分比
{ type: 'progress', content: '45%' }

// 格式3：状态消息
{ type: 'progress', content: '正在初始化...' }
```

##### `updateRealProgress(percent, message)`
更新进度条和显示信息。

**更新内容：**
- 进度条宽度
- 百分比文字
- 状态消息
- 预计剩余时间

##### `updateProgressMessage(message)`
仅更新状态消息（当没有明确百分比时）。

### 2. 后端支持 (server.js)

#### 流式响应端点

```javascript
app.post('/api/video/generate', async (req, res) => {
  if (useStream) {
    // 设置 SSE 头部
    res.setHeader('Content-Type', 'text/event-stream');
    res.setHeader('Cache-Control', 'no-cache');
    res.setHeader('Connection', 'keep-alive');

    // 发送进度更新
    res.write(`data: ${JSON.stringify({
      type: 'progress',
      content: '45%'
    })}\n\n`);

    // 发送完成消息
    res.write(`data: ${JSON.stringify({
      type: 'complete',
      choices: [...]
    })}\n\n`);
  }
});
```

### 3. API 接口 (sora2.js)

#### `generateVideoStream(prompt, options, onProgress)`
支持流式响应的视频生成方法。

**参数：**
- `prompt` - 提示词
- `options` - 生成选项
- `onProgress` - 进度回调函数

**示例：**
```javascript
await sora.generateVideoStream(
  '一只猫在花园里奔跑',
  { model: 'sora_video2' },
  (chunk, fullContent) => {
    console.log('Progress:', chunk);
  }
);
```

## 进度事件格式

### 事件类型

#### 1. progress - 进度更新

**格式1：包含百分比**
```json
{
  "type": "progress",
  "content": "正在生成视频... 45%"
}
```

**格式2：纯百分比**
```json
{
  "type": "progress",
  "content": "45%"
}
```

**格式3：状态消息**
```json
{
  "type": "progress",
  "content": "正在初始化生成器..."
}
```

#### 2. complete - 生成完成

```json
{
  "type": "complete",
  "content": "✅ 视频生成成功，[点击这里](URL) 查看视频~~~",
  "choices": [{
    "message": {
      "role": "assistant",
      "content": "完整响应内容"
    }
  }]
}
```

#### 3. error - 生成错误

```json
{
  "type": "error",
  "error": "错误消息"
}
```

## 前端显示逻辑

### 进度条更新流程

```
接收进度事件
    ↓
提取百分比/消息
    ↓
更新进度条宽度 (0-100%)
    ↓
更新百分比文字
    ↓
更新状态消息
    ↓
计算预计剩余时间
```

### 进度百分比提取

使用正则表达式提取：
```javascript
const percentMatch = content.match(/(\d+)%/);
if (percentMatch) {
  const percent = parseInt(percentMatch[1]);
  updateRealProgress(percent, content);
}
```

支持的格式：
- `45%`
- `进度: 45%`
- `正在生成... 45%`
- `Progress: 45%`

### 预计时间计算

基于当前进度和已用时间估算：
```javascript
const remainingPercent = 100 - percent;
const estimatedSeconds = Math.floor(
  (remainingPercent / percent) * elapsedTime
);
```

## 用户界面

### 进度显示区域

```html
<div id="progressIndicator">
  <div id="progressBar" style="width: 45%"></div>
  <div id="progressPercent">45%</div>
  <div id="statusText">正在生成视频...</div>
  <div id="elapsedTime">已等待 25 秒</div>
  <div id="estimatedTime">预计还需 30 秒</div>
</div>
```

### 进度条动画

CSS 过渡效果：
```css
#progressBar {
  transition: width 500ms ease-out;
}
```

## 使用示例

### 启用流式响应

在请求中设置 `useStream: true`：

```javascript
const requestBody = {
  prompt: "一只猫在花园里奔跑",
  model: "sora_video2",
  useStream: true  // 启用流式响应
};

const response = await fetch('/api/video/generate', {
  method: 'POST',
  body: JSON.stringify(requestBody)
});
```

### 处理进度更新

前端自动处理，无需额外代码：

```javascript
// 系统会自动：
// 1. 检测到 text/event-stream 响应类型
// 2. 调用 handleStreamResponse()
// 3. 实时更新进度显示
```

## 进度阶段说明

### 典型进度流程

| 进度 | 阶段 | 说明 | 预计时间 |
|------|------|------|---------|
| 0-10% | 初始化 | 模型加载和初始化 | 3-5秒 |
| 10-30% | 预处理 | 提示词处理和参数设置 | 5-10秒 |
| 30-70% | 生成 | 视频帧生成 | 20-50秒 |
| 70-90% | 渲染 | 视频渲染和合成 | 10-20秒 |
| 90-100% | 后处理 | 压缩和上传 | 5-10秒 |

### 15秒视频进度

15秒视频生成时间更长，各阶段耗时约为10秒视频的1.5-2倍。

## 错误处理

### 流式错误

如果流式响应中断或出错：

```javascript
try {
  await handleStreamResponse(response);
} catch (error) {
  console.error('[Video Stream] Error:', error);
  hideProgressIndicator();
  showError('视频生成失败', error.message);
}
```

### 超时处理

如果在5分钟内没有完成：

```javascript
const timeoutId = setTimeout(() => {
  controller.abort();
}, 300000); // 5分钟
```

## 兼容性说明

### 流式响应支持

**支持流式：**
- 设置 `useStream: true`
- 显示实时进度
- 更好的用户体验

**不支持流式（降级）：**
- 自动切换到普通 JSON 响应
- 显示模拟进度条
- 最终结果相同

### 浏览器兼容性

- ✅ Chrome/Edge 85+
- ✅ Firefox 80+
- ✅ Safari 14+
- ⚠️ IE 不支持（SSE 不兼容）

## 性能优化

### 进度更新频率

建议控制进度更新频率：
- 每 1-2 秒更新一次
- 避免过于频繁导致性能问题

### 数据传输

使用 SSE 而不是 WebSocket：
- 更简单的实现
- 单向通信即可
- 自动重连机制

## 调试技巧

### 查看流式事件

在浏览器控制台：
```javascript
// 查看所有流式事件
console.log('[Video Stream] Received:', parsed);

// 查看进度更新
console.log('[Video Progress]:', progressData);
```

### 测试进度显示

手动触发进度更新：
```javascript
// 模拟45%进度
updateRealProgress(45, '正在生成视频帧...');

// 模拟状态消息
updateProgressMessage('正在初始化...');
```

## 未来改进

### 计划功能

1. **更详细的阶段说明**
   - 显示当前处理的具体步骤
   - 每个阶段的预计时间

2. **可取消生成**
   - 允许用户中途取消
   - 返回部分生成结果

3. **队列显示**
   - 显示队列中的位置
   - 预估排队等待时间

4. **生成历史**
   - 保存进度日志
   - 用于分析和优化

## 总结

实时进度功能通过 SSE 流式响应实现，提供了：

✅ **实时反馈** - 用户清楚知道当前状态
✅ **时间预估** - 合理的等待时间预期
✅ **更好体验** - 避免"黑盒"等待焦虑
✅ **降级支持** - 不支持流式时自动降级

推荐在所有视频生成请求中启用 `useStream: true` 以获得最佳用户体验。
