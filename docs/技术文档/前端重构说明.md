# 前端重构说明 - 基于API文档

## 概述
根据接口文档 (`接口文档/生图.txt` 和 `接口文档/生视频.txt`),重新设计了前端的图像生成和编辑功能,使其完全符合 OpenAI Chat API 格式。

## 主要变更

### 1. API 格式统一
**所有图像生成和编辑都使用 `/v1/chat/completions` 端点**

#### 之前的格式(错误):
```javascript
// 错误的做法 - 使用 options 包装
{
  messages: [...],
  options: {
    model: 'sora_image',
    temperature: 0.7
  }
}
```

#### 现在的格式(正确):
```javascript
// 正确的做法 - 直接传递参数
{
  model: 'sora_image',
  messages: [...],
  stream: false
}
```

### 2. 文本生成图像 (Text to Image)

**文件**: `public/app.js` (行 415-426)

**请求格式**:
```javascript
{
  model: "sora_image",  // 或其他图像模型
  messages: [
    {
      role: "user",
      content: "画一只可爱的猫"
    }
  ],
  stream: false
}
```

**响应处理**:
- 从 `data.choices[0].message.content` 中提取 Markdown 格式的图片链接: `![](url)`
- 或提取直接的图片 URL

### 3. 图生图 (Image to Image)

**文件**: `public/app.js` (行 533-586)

**关键变更**:
- 使用 `content` 数组,支持多种内容类型
- 图片通过 `image_url` 类型传递

**请求格式**:
```javascript
{
  model: "doubao-seededit-3-0-i2i-250628",  // 图生图专用模型
  messages: [
    {
      role: "user",
      content: [
        {
          type: "text",
          text: "将这张图片转换为水彩画风格"
        },
        {
          type: "image_url",
          image_url: {
            url: "data:image/png;base64,..."  // Base64 编码的图片
          }
        }
      ]
    }
  ],
  stream: false
}
```

**响应处理**:
- 与文本生成图像相同,从 chat 响应中提取图片 URL

### 4. 模型列表更新

**文件**: `public/index.html` (行 456-470)

**新增模型**:
- `gpt-image-1` - GPT Image 1
- `gpt-4o-image` - GPT-4o Image
- `flux-kontext-pro` - Flux Kontext Pro (支持参考图)
- `flux` - Flux 系列
- `dall-e-3` - DALL-E 3
- `recraftv3` - Recraft V3
- `qwen-image` - 通义千问图像
- `nano-banana` - Nano Banana
- `nano-banana-hd` - Nano Banana HD
- `doubao-seedream-4-0-250828` - 豆包 SeeDream 4.0
- `doubao-seededit-3-0-i2i-250628` - 豆包 SeeEdit 3.0 (图生图)
- `doubao-seedream-3-0-t2i-250415` - 豆包 SeeDream 3.0

### 5. 服务器端适配

**文件**: `server.js` (行 22-82)

**变更内容**:
- 支持新旧两种请求格式
- 自动合并 `model`, `stream` 等参数
- 向后兼容旧的 `options` 格式

**兼容性处理**:
```javascript
const options = {
  model: model || req.body.options?.model,
  stream: stream !== undefined ? stream : req.body.options?.stream,
  ...otherOptions,
  ...(req.body.options || {})
};
```

## 错误处理改进

### 1. JSON 解析错误处理
**文件**: `public/app.js` (行 437-446, 588-597)

**问题**: 服务器返回 HTML 错误页面时,尝试解析 JSON 会失败

**解决方案**:
```javascript
if (!response.ok) {
    let errorMessage = 'Image generation failed';
    try {
        const errorData = await response.json();
        errorMessage = errorData.error || errorData.error?.message || errorMessage;
    } catch (e) {
        // 如果返回的不是 JSON,使用 HTTP 状态
        errorMessage = `Server error: ${response.status} ${response.statusText}`;
    }
    throw new Error(errorMessage);
}
```

### 2. 历史记录数据验证
**文件**: `public/app.js` (行 10-25, 1014-1028, 1044-1082)

**改进**:
- 加载时过滤损坏的历史记录
- 保存前验证数据结构
- 渲染时跳过无效项目
- 自动清理 localStorage 中的损坏数据

## 功能特性

### 1. 图像生成
- ✅ 多模型支持 (13+ 模型)
- ✅ 提示词和负面提示词
- ✅ 尺寸选择 (正方形/横屏/竖屏)
- ✅ 生成数量 (1/2/4 张)
- ✅ 高级设置 (种子值、步数、CFG Scale)
- ✅ 进度提示
- ✅ 历史记录

### 2. 图像编辑
- ✅ 图片上传
- ✅ 多种编辑类型:
  - Style Transfer (风格转换)
  - Variation (变体生成)
  - Enhance (增强)
  - Inpaint (局部编辑)
- ✅ 使用 Chat API 格式
- ✅ 支持参考图片
- ✅ 历史记录

### 3. 用户体验
- ✅ 实时进度显示
- ✅ 清晰的错误消息
- ✅ 图片下载和复制
- ✅ 历史记录查看
- ✅ 响应式设计

## 测试建议

### 1. 文本生成图像测试
```bash
# 测试不同模型
- sora_image
- gpt-4o-image
- dall-e-3
- flux

# 测试不同提示词
- 简单描述: "一只猫"
- 详细描述: "一只可爱的橘猫,坐在窗台上,阳光洒在它身上,高清摄影"
- 负面提示词: "模糊,低质量,变形"
```

### 2. 图生图测试
```bash
# 测试编辑类型
- Style: "转换为水彩画风格"
- Variation: "创建相似但不同的版本"
- Enhance: "提升质量和细节"

# 使用模型
- doubao-seededit-3-0-i2i-250628 (推荐)
- flux-kontext-pro (需要参考图)
```

### 3. 错误场景测试
```bash
# 测试错误处理
- 无效的 API 密钥
- 超时情况
- 服务器错误 (500)
- 网络错误
- 损坏的历史记录数据
```

## 兼容性说明

### 向后兼容
- ✅ 旧的 `options` 格式仍然支持
- ✅ 服务器自动合并新旧格式
- ✅ 不影响现有的视频生成和聊天功能

### 弃用的功能
- ❌ `/api/image/generate` 端点 (现在使用 `/api/chat`)
- ❌ `/api/image/edit` 端点 (现在使用 `/api/chat`)

## 下一步优化建议

1. **流式生成支持** - 某些模型可能支持流式图片生成
2. **批量生成** - 支持一次生成多张不同的图片
3. **图片预处理** - 自动调整上传图片的大小和格式
4. **提示词优化** - AI 辅助优化提示词
5. **更多编辑选项** - 添加更多图像编辑功能

## 相关文件

### 前端文件
- `public/app.js` - 主要逻辑
- `public/index.html` - 页面结构
- `public/i18n.js` - 国际化

### 后端文件
- `server.js` - Express 服务器
- `sora2.js` - API 客户端

### 文档
- `接口文档/生图.txt` - 图像生成 API 文档
- `接口文档/生视频.txt` - 视频生成 API 文档

## 总结

这次重构完全基于官方 API 文档,确保了:
1. ✅ API 调用格式正确
2. ✅ 支持所有官方模型
3. ✅ 错误处理健壮
4. ✅ 向后兼容
5. ✅ 用户体验良好

所有功能现在都遵循 OpenAI Chat API 标准,更易于维护和扩展。
