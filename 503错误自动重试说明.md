# 503 错误自动重试机制说明

## 问题描述

当 API 服务暂时不可用时，会返回 503 错误（Service Unavailable）。这通常是由于：
- API 服务器负载过高
- 服务正在维护
- 临时网络问题
- 上游服务不可用

## 自动重试机制

系统已实现智能重试机制，自动处理 503 错误：

### 重试策略

1. **最大重试次数**：3 次
2. **渐进延迟**：
   - 第 1 次重试：等待 3 秒
   - 第 2 次重试：等待 5 秒
   - 第 3 次重试：等待 7 秒

3. **可重试的错误类型**：
   - 503 Service Unavailable
   - 504 Gateway Timeout
   - 网络超时（timeout）
   - 连接重置（ECONNRESET）
   - 请求中止（AbortError）

### 用户体验

当遇到 503 错误时，用户会看到：

```
⚠️ API 服务暂时不可用 (503)

等待 3 秒后自动重试...
(尝试 1/4)
```

系统会自动：
1. 显示友好的错误提示
2. 倒计时等待
3. 自动重试请求
4. 更新进度信息

### 流式响应中的错误处理

对于使用流式响应（SSE）的视频生成：

1. **错误检测**：
   ```javascript
   {
     "type": "error",
     "error": "Request failed with status code 503",
     "statusCode": 503
   }
   ```

2. **错误传播**：
   - 流式响应中的错误会被捕获
   - 错误包含 `statusCode` 属性
   - 外层重试逻辑会识别状态码

3. **自动重试**：
   - 识别到 503 错误后自动触发重试
   - 使用相同的渐进延迟策略
   - 保持用户界面响应

## 代码实现

### 1. 流式响应错误处理

```javascript
if (parsed.type === 'error') {
    const errorMsg = parsed.error || 'Stream error';
    const statusCode = parsed.statusCode || 500;
    
    // 构造包含状态码的错误
    const error = new Error(errorMsg);
    error.statusCode = statusCode;
    throw error;
}
```

### 2. 重试条件判断

```javascript
const isRetryable = (
    error.name === 'AbortError' ||
    error.statusCode === 503 ||
    error.statusCode === 504 ||
    error.message.includes('503') ||
    error.message.includes('504') ||
    error.message.includes('timeout') ||
    // ... 其他条件
);
```

### 3. 重试执行

```javascript
if (isRetryable && retryCount < MAX_RETRIES) {
    const retryDelay = 3000 + (retryCount * 2000);
    
    updateProgressMessage(
        `⚠️ API 服务暂时不可用 (503)\n\n` +
        `等待 ${Math.round(retryDelay/1000)} 秒后自动重试...\n` +
        `(尝试 ${retryCount + 1}/${MAX_RETRIES + 1})`
    );
    
    await new Promise(resolve => setTimeout(resolve, retryDelay));
    return await attemptVideoGeneration(requestBody, prompt, model, retryCount + 1);
}
```

## 最佳实践

### 用户建议

1. **耐心等待**：系统会自动重试，无需手动操作
2. **避免高峰期**：如果频繁遇到 503，可以稍后再试
3. **检查网络**：确保网络连接稳定
4. **查看日志**：打开浏览器控制台查看详细信息

### 开发者建议

1. **监控重试率**：如果重试率过高，考虑增加延迟或减少并发
2. **日志记录**：所有重试都会记录在控制台
3. **用户反馈**：提供清晰的进度提示
4. **降级策略**：考虑在多次失败后提供替代方案

## 错误排查

### 如果重试全部失败

1. **检查 API 状态**：
   - 访问 API 服务商的状态页面
   - 检查是否有维护公告

2. **检查配置**：
   - 验证 API Key 是否正确
   - 验证 API URL 是否正确
   - 检查是否使用了正确的 API（标准 vs Pro）

3. **查看控制台**：
   ```
   [Video] Attempt 1 error: Error: Request failed with status code 503
   [Video] Retryable error detected, retrying in 3000ms... (1/3)
   [Video] Attempt 2 error: Error: Request failed with status code 503
   [Video] Retryable error detected, retrying in 5000ms... (2/3)
   [Video] Attempt 3 error: Error: Request failed with status code 503
   [Video] Retryable error detected, retrying in 7000ms... (3/3)
   [Video] Max retries (3) exceeded
   ```

4. **联系支持**：
   - 如果问题持续，联系 API 服务商
   - 提供错误日志和时间戳

## 配置选项

### 修改重试参数

在 `public/app.js` 中：

```javascript
const MAX_RETRIES = 3;  // 最大重试次数
const RETRY_DELAY = 3000;  // 基础延迟（毫秒）

// 渐进延迟计算
const retryDelay = 3000 + (retryCount * 2000);
```

### 自定义错误提示

```javascript
let errorType = '服务错误';
if (error.statusCode === 503 || error.message.includes('503')) {
    errorType = 'API 服务暂时不可用 (503)';
}
```

## 监控和统计

### 建议添加的监控指标

1. **重试成功率**：重试后成功的请求比例
2. **平均重试次数**：每个请求平均重试多少次
3. **503 错误频率**：单位时间内的 503 错误数量
4. **重试延迟影响**：重试对总响应时间的影响

### 日志示例

```
[Video] Attempt 1 error: Error: Request failed with status code 503
[Video] Retryable error detected, retrying in 3000ms... (1/3)
⚠️ API 服务暂时不可用 (503)
等待 3 秒后自动重试...
(尝试 1/4)
[Video] Attempt 2 success
✅ 视频生成成功！
```

## 总结

- ✅ 自动检测 503 错误
- ✅ 智能重试机制（最多 3 次）
- ✅ 渐进延迟策略（3s → 5s → 7s）
- ✅ 友好的用户提示
- ✅ 详细的日志记录
- ✅ 支持流式和非流式响应

系统会自动处理临时的服务不可用问题，用户无需手动干预。
